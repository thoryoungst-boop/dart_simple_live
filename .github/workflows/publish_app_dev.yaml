name: Build iOS Only (Force Fix)

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    tags:
      - "v*"

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      # 1. ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. è®¾ç½® Java
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # 3. è®¾ç½® Flutter (3.27.1)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          channel: 'stable'
          cache: true

      # 4. æš´åŠ›ä¿®å¤ä¾èµ– & ç”Ÿæˆä»£ç 
      # ä½¿ç”¨ sed å‘½ä»¤ç›´æ¥ä¿®æ”¹æ–‡æœ¬æ–‡ä»¶ï¼Œç»•è¿‡ Flutter çš„ç‰ˆæœ¬æ£€æŸ¥
      - name: Force Fix Dependencies
        run: |
          cd simple_live_app
          
          # æ¸…ç†ç¼“å­˜
          flutter clean
          rm -f pubspec.lock
          
          # ã€å…³é”®ä¿®æ”¹ã€‘
          # ä½¿ç”¨ sed å¼ºè¡Œåˆ é™¤ pubspec.yaml ä¸­ç°æœ‰çš„ intl å’Œ lottie é…ç½®è¡Œ
          # è¿™æ ·å¯ä»¥é˜²æ­¢ pub add è¿è¡Œæ—¶å› ä¸ºæ—§ç‰ˆæœ¬å†²çªè€ŒæŠ¥é”™
          sed -i '' '/intl:/d' pubspec.yaml
          sed -i '' '/lottie:/d' pubspec.yaml
          
          # ç°åœ¨æ–‡ä»¶é‡Œå·²ç»æ²¡æœ‰è¿™ä¸¤ä¸ªåº“äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¹²å‡€åœ°æ·»åŠ æŒ‡å®šç‰ˆæœ¬
          flutter pub add intl:0.19.0
          flutter pub add lottie:3.1.0
          
          # å®‰è£…å‰©ä½™ä¾èµ–
          flutter pub get
          
          # ç”Ÿæˆä»£ç 
          dart run build_runner build --delete-conflicting-outputs

      # 5. å®‰è£… iOS Pods
      - name: Install CocoaPods
        run: |
          cd simple_live_app/ios
          rm -rf Pods Podfile.lock
          pod install --repo-update

      # 6. ç¼–è¯‘ iOS (å…ç­¾å)
      - name: Build IPA (No CodeSign)
        run: |
          cd simple_live_app
          # ç¼–è¯‘
          flutter build ios --release --no-codesign
          
          # æ‰“åŒ…
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload

      # 7. ä¸Šä¼ 
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
          retention-days: 3

      # å®Œæˆ
      - run: echo "ğŸ iOS Build Finished."
