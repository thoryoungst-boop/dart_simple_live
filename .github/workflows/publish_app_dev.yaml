name: Build iOS Only

on:
  workflow_dispatch: # 允许手动点击运行
  push:
    branches:
      - master
      - main
      - dev

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      # 1. 下载代码 (自动处理子模块)
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 配置 Flutter 环境 (使用稳定版 3.22.0)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: 'stable'
          cache: true

      # 3. 安装依赖 & 生成代码 (关键步骤，不可少)
      - name: Install Dependencies & Run Build Runner
        run: |
          cd simple_live_app
          flutter pub get
          # 这一步非常重要，用于生成 JSON 序列化文件，没有它会报错
          dart run build_runner build --delete-conflicting-outputs

      # 4. 安装 iOS 专用依赖 (CocoaPods)
      - name: Install CocoaPods
        run: |
          cd simple_live_app/ios
          pod install --repo-update

      # 5. 编译 iOS (免签名模式)
      # 因为没有开发者证书，我们编译成无签名的 .app，然后手动打包成 .ipa
      - name: Build IPA (No CodeSign)
        run: |
          cd simple_live_app
          # 编译 Release 包，禁用代码签名
          flutter build ios --release --no-codesign
          
          # 手动制作 IPA 结构
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          # 压缩成 IPA 文件
          zip -q -r simple_live_unsigned.ipa Payload

      # 6. 上传结果
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: simple_live_app/simple_live_unsigned.ipa
          retention-days: 5
