name: Build iOS Final Fix v2

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main
      - dev
      - 'v*'

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      # 1. 下载代码
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 配置 Java环境
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # 3. 配置 Flutter (保持最新版 3.27.1)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1" 
          channel: 'stable'
          cache: true

      # 4. 安装依赖 (关键步骤：连续降级大法)
      - name: Install Dependencies
        run: |
          cd simple_live_app
          
          # 清理缓存
          flutter clean
          
          # =======================================================
          # 【核心修复区】
          # 既然依赖冲突，我们就手动指定一个肯定能用的旧版本
          # =======================================================
          
          # 1. 修复 intl 冲突
          flutter pub add intl:0.19.0
          
          # 2. 修复 lottie 冲突 (降级到 3.1.0，这个版本非常稳定)
          flutter pub add lottie:3.1.0
          
          # 3. 正常安装其他依赖
          flutter pub get
          
          # 生成代码 (如果报错强制继续)
          dart run build_runner build --delete-conflicting-outputs || true

      # 5. 安装 iOS Pods
      - name: Install CocoaPods
        run: |
          cd simple_live_app/ios
          rm -rf Pods
          rm -rf Podfile.lock
          pod install --repo-update

      # 6. 编译 iOS (免签名)
      - name: Build IPA (No CodeSign)
        run: |
          cd simple_live_app
          # 编译 Release 包
          flutter build ios --release --no-codesign --verbose
          
          # 打包 IPA
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -q -r simple_live_unsigned.ipa Payload

      # 7. 上传结果
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: simple_live_app/simple_live_unsigned.ipa
          retention-days: 5
