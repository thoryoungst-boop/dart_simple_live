name: Build iOS Only

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  push:
    branches:
      - "**" # å…è®¸æ‰€æœ‰åˆ†æ”¯è§¦å‘
    tags:
      - "v*"

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      # 1. ç­¾å‡ºä»£ç  (å»æ‰äº† ref: devï¼Œé˜²æ­¢æŠ¥é”™)
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. è®¾ç½®JAVAç¯å¢ƒ (ä¿ç•™åŸé…ç½®)
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # 3. è®¾ç½®Flutter (ä¿®æ­£ä¸º 3.27.1 ä»¥è§£å†³ url_launcher æŠ¥é”™)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          channel: 'stable'
          cache: true

      # 4. æ ¸å¿ƒæ­¥éª¤ï¼šè§£å†³ä¾èµ–å†²çª & ç”Ÿæˆä»£ç 
      # (è¿™é‡Œå¿…é¡»ä¿®æ”¹ï¼Œå¦åˆ™è™½ç„¶ä»£ç å°‘ï¼Œä½†è·‘ä¸é€š)
      - name: Fix Dependencies & Restore
        run: |
          cd simple_live_app
          flutter clean
          
          # å¼ºåˆ¶è§£å†³ç‰ˆæœ¬å†²çª (intl å’Œ lottie)
          flutter pub add intl:0.19.0
          flutter pub add lottie:3.1.0
          
          # å®‰è£…ä¾èµ–
          flutter pub get
          
          # ç”Ÿæˆ .g.dart æ–‡ä»¶ (å¿…é¡»æ­¥éª¤)
          dart run build_runner build --delete-conflicting-outputs

      # 5. å®‰è£… iOS ä¸“ç”¨ä¾èµ– (CocoaPods)
      - name: Install CocoaPods
        run: |
          cd simple_live_app/ios
          rm -rf Pods Podfile.lock
          pod install --repo-update

      # 6. æ‰“åŒ…å…ç­¾å IPA
      - name: Build IPA (No CodeSign)
        run: |
          cd simple_live_app
          # ç¼–è¯‘ Release åŒ… (ç¦ç”¨ç­¾å)
          flutter build ios --release --no-codesign
          
          # æ‰‹åŠ¨æ‰“åŒ…æˆ IPA ç»“æ„ (ä¿ç•™äº†ä½ åŸæ¥çš„é€»è¾‘)
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload

      # 7. ä¸Šä¼  IPA è‡³ Artifacts
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
          retention-days: 3

      # å®Œæˆ
      - run: echo "ğŸ iOS Build Finished."
